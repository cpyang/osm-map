<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="osm-point.html">
<script src="http://openlayers.org/en/v3.11.2/build/ol.js"></script>

<!--
The `osm-poly` element provides a possibility to draw on the `osm-map`element.

Example:

    <osm-poly fill fill-color="rgba(0,10,150,0.4)">
        <template is="dom-repeat" items="{{ points }}">
          <osm-point longitude$="{{ item.longitude }}" latitude$="{{ item.latitude }}"></osm-point>
        </template>
    </osm-poly> 

@demo demo/index.html
-->

<dom-module id="osm-poly">
  <script>
    Polymer({
      is: 'osm-poly',
      properties: {
        /**
         * The stroke color.
         */ 
        strokeColor: {
          type: String,
          value: '#0091ea',
          notify: true
        },

        /**
         * A stroke width.
         */
        width: {
          type: Number,
          value: 4,
          notify: true
        },

        /**
         * If true the polygon will be filled.
         */
        fill: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Defines a fill color for the polygon. Requires fill = true. 
         */
        fillColor: {
          type: String,
          value: 'rgba(0,150,10,0.4)',
          notify: true
        }
      },

      attached: function (argument) {
        this._observer = Polymer.dom(this).observeNodes( function(info) {
          this.fire('update-layers');
        });
      },

      polygon: function() {
        points = [];
        $.each(this.queryAllEffectiveChildren('osm-point'), function(index, point) {
          points.push(point.position());

          if(this.fill && index == this.queryAllEffectiveChildren('osm-point').length)
            points.push(this.queryAllEffectiveChildren('osm-point')[0].position());
        });

        geometry = new ol.geom.LineString(points, 'XY');

        // need to transfrom the lineString described in 
        // https://groups.google.com/forum/#!topic/ol3-dev/TqLw0RRJLXw
        geometry.transform('EPSG:4326', 'EPSG:3857');

        return new ol.layer.Vector({
          source: new ol.source.Vector({
              features: [new ol.Feature({ geometry: geometry })]
          }),
          style: new ol.style.Style({
              stroke: new ol.style.Stroke({ color: this.strokeColor, width: this.width }),
              fill: new ol.style.Fill({
                color: this.fillColor
              })
          }),
          name: 'routeLayer'
        });
      }
    });
  </script>
</dom-module>
