<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>osm-map Demo</title>
    <script src="../../webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="../../paper-input/paper-input.html">
    <link rel="import" href="../../paper-drawer-panel/paper-drawer-panel.html">
    <link rel="import" href="../../paper-header-panel/paper-header-panel.html">
    <link rel="import" href="../../iron-flex-layout/classes/iron-flex-layout.html">
    <link rel="import" href="../../paper-toolbar/paper-toolbar.html">
    <link rel="import" href="../../paper-icon-button/paper-icon-button.html">
    <link rel="import" href="../../paper-button/paper-button.html">
    <link rel="import" href="../../iron-icons/iron-icons.html" >
    <link rel="import" href="../../iron-icon/iron-icon.html" >
    <link rel="import" href="../../iron-ajax/iron-ajax.html"></link>
    <link rel="import" href="../osm-map.html">
    <link rel="import" href="../osm-marker.html">
    <link rel="import" href="../osm-layer.html">
    <link rel="import" href="../osm-poly.html">
    <link rel="import" href="../osm-point.html">
    <style type="text/css">
      html, body {
        height: 100%;
        width: 100%;
        margin : 0;
        overflow: hidden;  
        font-family: 'Open Sans', sans-serif;
      }
    </style>
  </head>
  <body unresolved>
    <template id="demo" is="dom-bind">

      <iron-ajax
        id="ajax"
        verbose
        handle-as="json"
        on-response="finishedGeocoding">
      </iron-ajax>


      <paper-drawer-panel>
        <paper-header-panel drawer>
          <paper-toolbar>
            <h3><code>&lt;osm-map&gt;</code> Demo</h3>
          </paper-toolbar>
          <div main>
            <datalist id="addresses">
              <template is="dom-repeat" items="{{suggestions}}" as="suggestion">
                  <option value="{{suggestion.display_name}}"></option>
              </template>
            </datalist>

            <paper-input id="start" label="Start" type="search"
              placeholder="Set a start address" autocomplete="on" list="addresses" on-keyup="cumputeStartSuggestions" results="5">
            </paper-input>
            <paper-input id="destination" label="Destination" type="search"
              placeholder="Set a destination address" autocomplete="on" list="addresses" on-keyup="cumputeDestinationSuggestions" results="5">
            </paper-input>

            <paper-button role="button" raised>
              <iron-icon icon="send"></iron-icon>
              Start Navigation
            </paper-button>
          </div>
        </paper-header-panel>
        <paper-header-panel main>
          <paper-toolbar>
            <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          </paper-toolbar>
          
          <osm-map class="content fit">
            <osm-poly fill fill-color="rgba(0,10,150,0.4)">
                <template is="dom-repeat" items="{{ points }}">
                  <osm-point longitude$="{{ item.longitude }}" latitude$="{{ item.latitude }}"></osm-point>
                </template>
            </osm-poly>
          </osm-map>
        </paper-header-panel>
      </paper-drawer-panel>
    </template>
  </body>
  <script>
  //TODO: https://github.com/Project-OSRM/osrm-backend/wiki/Server-api
    var demo = document.querySelector('#demo');

    demo.cumputeStartSuggestions = function () {
      var ajax = document.querySelector('#ajax');
      var start = document.querySelector('#start');
      var requests = ajax.activeRequests;

      if (requests.length > 0)
        for (var i = 0; i < requests.length; i++) 
          requests[i].abort();

      document.querySelector('#ajax').url = "http://nominatim.openstreetmap.org/search?format=json&q="+start.value;
      document.querySelector('#ajax').generateRequest();
    }

    demo.cumputeDestinationSuggestions = function () {
      var ajax = document.querySelector('#ajax');
      var destination = document.querySelector('#destination');
      var requests = ajax.activeRequests;

      if (requests.length > 0)
        for (var i = 0; i < requests.length; i++) 
          requests[i].abort();

      document.querySelector('#ajax').url = "http://nominatim.openstreetmap.org/search?format=json&q="+destination.value;
      document.querySelector('#ajax').generateRequest();
    }

    demo.finishedGeocoding = function (request) {
      demo.suggestions = request.detail.response;
      console.log(demo.suggestions)
    }
    
  </script>
</html>
